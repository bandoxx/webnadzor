{% extends 'base.html.twig' %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(document).ready(function() {

            $('.toggle').click(function() { /* BLOCK TOGGLE */
                $(this).toggleClass('show');
                $(this).parent().parent().children('.block_cont').slideToggle(300);
                $(this).parent().toggleClass('show');
                return false;
            });

            $('.tipTop').tipsy({gravity: 's', fade: true}); /* TOOLTIP CLASS */
            $('.tipBot').tipsy({gravity: 'n', fade: true}); /* TOOLTIP CLASS */
            $('.tipLeft').tipsy({gravity: 'e', fade: true}); /* TOOLTIP CLASS */
            $('.tipRight').tipsy({gravity: 'w', fade: true}); /* TOOLTIP CLASS */

            $('.ie #userbar').corner('top 5px'); /* IE BORDER-RADIUS FIX */
            $('.ie .titlebar').corner('top 5px'); /* IE BORDER-RADIUS FIX */
            $('.ie .block_cont').corner('bottom 5px'); /* IE BORDER-RADIUS FIX */
            $('.ie .error, .ie .warning, .ie .success, .ie .information').corner('5px'); /* IE BORDER-RADIUS FIX */

            $('#device_add').click(function() { /* ADD DEVICE */
                $('#add-form').dialog({
                    autoOpen: true,
                    show: {
                        effect: 'drop',
                        duration: 200
                    },
                    hide: {
                        effect: 'drop',
                        duration: 200
                    },
                    resizable: false,
                    modal: true,
                    buttons: {
                        'Dodaj novu lokaciju': function() {
                            $('#addform').submit();
                            return false;
                        },
                        'Odustani': function() {
                            $(this).dialog('close');
                        }
                    },
                    close: function() {
                        $('#addform').validationEngine('hideAll');
                        $('#addform label').removeClass('ui-state-active');
                        $(this).dialog('destroy');
                    }
                });
                $('#addform').validationEngine('attach', {
                    onValidationComplete: function(form, status){
                        var form_data = $('#addform').serialize();
                        if (status === true) {
                            $.ajax({
                                url: "{{ path('api_device_create', {clientId: clientId}) }}",
                                data: form_data,
                                dataType: 'json',
                                type: 'POST',
                                success: function(response) {
                                    $(location).attr('href', "/admin/" + {{ clientId }} + "/device/" + response + "/edit")
                                },
                                error: function() {
                                    alert('Greška! Molimo pokušajte ponovo');
                                }
                            });
                        }
                    }
                });/* VALIDATION ENGINE */
                return false;
            });

            $('.radioui').buttonset();

            $('#otable').wrap('<div class="table-wrap" />'); /* NORMAL TABLE */
            $('#otable tr:even').addClass('even'); /* ODD/EVEN TABLEROW CLASS */
            $('#otable').dataTable({
                pageLength: 100,
                language: {
                    search: "Pretraga",
                    loading: "Ucitavanje...",
                    lengthMenu: '_MENU_ broj prikaza',
                    emptyTable: 'Prazna tablica',
                    info: 'Prikaz _START_ od _END_ od ukupno _TOTAL_ rezultata',
                    infoEmpty: '',
                    infoFiltered: '(filtrirano od _MAX_ rezultata)',
                },
                columnDefs: [
                    { orderable: false, targets: 7 },
                    { className: 'dt-center', targets: '_all' }
                ],
            }); /* DATA TABLES */

            var delete_parent, delete_id, delete_devnam = '';
            $('.delete').live('click', function(e) { /* DELETE DEVICE */
                console.log("DELETE CLICKED");
                delete_parent = $(this).parent();
                delete_id = $(delete_parent).attr('id');
                delete_devnam = $(delete_parent).data('devnam');

                $('#del_device_name').html(delete_devnam);
                $('#delform input[type=radio]').click(function(){
                    $('#del_password').removeAttr('disabled');
                });

                $('#delete-confirm').dialog({
                    autoOpen: true,
                    show: {
                        effect: 'drop',
                        duration: 200
                    },
                    hide: {
                        effect: 'drop',
                        duration: 200
                    },
                    resizable: false,
                    modal: true,
                    buttons: {
                        '!! POTVRDI !!': function() {
                            $('#delform').submit();
                            return false;
                        },
                        'Odustani': function() {
                            $(this).dialog('close');
                        }
                    },
                    close: function() {
                        $('#delform').validationEngine('hideAll');
                        $('#delform input[type=password]').val('').attr('disabled', 'disabled');
                        $('#delform label').removeClass('ui-state-active');
                        $('#del_device_name').html('');
                        $(this).dialog('destroy');
                    }
                });
                $('#delform').validationEngine('attach', {
                    onValidationComplete: function(form, status){
                        var form_data = $('#delform').serialize();
                        if (status === true) {
                            $.ajax({
                                url: "/api/{{ clientId }}/device/" + delete_id,
                                data: form_data,
                                dataType: 'json',
                                type: 'POST',
                                success: function() {
                                    $('#delete-confirm').dialog('close');
                                    window.location.reload();
                                },
                                error: function() {
                                    alert('Greška! Molimo pokušajte ponovo');
                                }
                            });
                        }
                    }
                });/* VALIDATION ENGINE */
                return false;
            });
        });


    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js"></script>
{% endblock %}
{% block body %}
    {{ parent() }}
    <div id="delete-confirm" title="Obriši podatke ili obriši lokaciju?" style="display:none;">
        <p style="border: 1px solid transparent; padding: 0.3em;">Molimo budite pažljivi, podaci će biti trajno
            izbrisani.</p>
        <p style="border: 1px solid transparent; padding: 0.3em;"><strong>Lokacija:</strong> <span
                    id="del_device_name"></span></p>
        <form id="delform" class="form" action="#" method="POST">
            <fieldset>
                <div class="form_row radioui">
                    <label style="display:block; margin-top:12px;">Odaberite opciju</label>
                    <input type="radio" id="r4" name="del_action" class="radio validate[required]"
                           value="empty_data"/><label for="r4">Obriši podatke</label>
                    <input type="radio" id="r5" name="del_action" class="radio validate[required]"
                           value="delete_device"/><label for="r5">Obriši lokaciju</label>
                </div>
                <div class="form_row">
                    <label for="del_password" style="display:block; margin-top:12px;">Trenutna zaporka</label>
                    <input type="password" name="del_password" id="del_password"
                           class="input text ui-widget-content ui-corner-all"
                           style="display:block; width:95%; padding: .4em;" disabled="disabled"/>
                </div>
            </fieldset>
        </form>
    </div>

{% endblock %}

     {% block navigation %}
         {% if app.user.permission == 4 %}
             <li><a href="{{ path('admin_client_settings', {clientId: clientId}) }}" class="icon_settings">Podešavanja</a></li>
             <li><a href="{{ path('admin_overview') }}" class="icon_users">Klijenti</a></li>
         {% endif %}

         {% if app.user.permission >= 2 %}
             <li><a href="{{ path('app_device_list', {clientId: clientId}) }}" class="icon_monitor">Mjerni uređaji</a></li>
             <li><a href="{{ path('app_clientftp_read', {clientId: clientId}) }}" class="icon_bookmark">FTP podaci</a></li>
             <li><a href="{{ path('app_user_getusers', {clientId: clientId}) }}" class="icon_users">Korisnici</a></li>
             <li><a href="{{ path('app_loginlog_getloginlogs', {clientId: clientId}) }}" class="icon_article">Dnevnik prijava</a></li>
         {% endif %}

         {% if app.user.permission == 5 %}
            <li><a href="{{ path('image_upload_form', {clientId: clientId}) }}" class="icon_monitor">Upload slike za klijenta</a></li>
            <li><a href="{{ path('image_index', {clientId: clientId}) }}" class="icon_monitor">Pregled slika za klijenta</a></li>
         {% endif %}

         <li><a href="{{ path('app_logout') }}" class="icon_logout">Odjava</a></li>
     {% endblock %}

{% block content %}
    <div class="clear"></div>
    <div id="body">
        <div class="block big"><!-- Block Begin -->
            <div class="titlebar">
                <h3>Pregled mjernih uređaja</h3>
                <a href="#" class="toggle">&nbsp;</a>
            </div>
            <div class="block_cont" style="padding: 4px;">
                <div id="otable_wrapper" class="dataTables_wrapper" role="grid">
                    <div class="clear"></div>
                    <div id="otable_processing" class="dataTables_processing" style="visibility: hidden;">
                        Obrađujem...
                    </div>
                    <table id="otable" class="data-table-border stripe compact hover"><!-- Table Wrapper Begin -->
                        <thead>
                        <tr role="row">
                            <th>Ime</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for clientStorage in clientStorages %}
                            <tr>
                                <td>{{ clientStorage.name }}</td>
                                <td>
                                    <div id="{{ clientStorage.id }}" data-devnam="{{ clientStorage.name }}" class="actionbar">
                                        <a href="{{ path('update_devices', {clientId: clientId, clientStorageId: clientStorage.id}) }}" class="action edit">
                                            <span>Uredi</span>
                                        </a>
                                        <a href="{{ path('app_client_storage_device_entry_show', {clientId: clientId,clientStorageId: clientStorage.id}) }}" class="action view">
                                            <span>Pogledaj</span>
                                        </a>
{#                                        <form action=""{{ path('app_client_storage_device_entry_delete', {clientId: clientId,clientStorageId: clientStorage.id}) }}">#}

                                            <a href="#" class="action delete"><span>Obrisi</span></a>

{#                                        </form>#}

                                        <a href="{{ path('client_devices_overview', {clientId: clientId,clientStorageId: clientStorage.id}) }}" class="action">
                                            <button>Dodaj </button>
                                        </a>

                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>



                    <div class="clear"></div>
                    <div class="data-table-bottom"></div>
                    <div class="clear"></div>
                </div><!-- Table Wrapper End -->
            </div>
        </div><!-- Block End -->
    </div>
{% endblock %}

{% block bottom_javascripts %}
    {{ parent() }}

    <script>
        $(document).ready(function () {
            $('#myTable').DataTable({
                scrollY: true,
                scroller: {
                    rowHeight: 10
                }
            });
        });
    </script>

{% endblock %}