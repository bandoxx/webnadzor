{% extends 'v2/base.html.twig' %}

{% block head %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>
    <!--HIGHCHARTS CODE IMPORT-->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/stock/modules/stock.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <!--HIGHCHARTS CODE IMPORT-->
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
{% endblock %}

{% block body %}
    <body
            x-data="{ page: 'dataTables', modalOpenEdit: false, 'loaded': true, 'darkMode': true, 'stickyMenu': false, 'sidebarToggle': false, 'scrollTop': false }"
            x-init="
          darkMode = JSON.parse(localStorage.getItem('darkMode'));
          $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
            :class="{'dark text-bodydark bg-boxdark-2': darkMode === true}"
    >
    <!-- ===== Preloader Start ===== -->
    {% block preloader %}
        {{ parent() }}
    {% endblock %}
    <!-- ===== Preloader End ===== -->

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
        <!-- ===== Sidebar Start ===== -->
        <aside
                :class="sidebarToggle ? 'translate-x-0' : '-translate-x-full'"
                @click.outside="sidebarToggle = false"
                class="absolute left-0 top-0 z-9999 flex h-screen w-72.5 flex-col bg-black duration-300 ease-linear dark:bg-boxdark lg:static lg:translate-x-0"
        >
            <!-- SIDEBAR HEADER -->
            {% block sidebar_header %}
                {{ parent() }}
            {% endblock %}
            <!-- SIDEBAR HEADER -->

            <div
                    class="no-scrollbar flex flex-col duration-300 ease-linear"
            >
                <!-- Sidebar Menu -->
                <nav
                        class="mt-5 px-4 py-4 lg:mt-9 lg:px-6"
                        x-data="{selected: $persist('Dashboard')}"
                >
                    <!-- Menu Group -->
                    <div>
                        <h3 class="mb-4 ml-4 text-sm font-medium text-bodydark2">MENU</h3>
                        <!-- Support Group -->
                        <div>
                            <ul class="mb-6 flex flex-col gap-1.5">
                                <!-- Menu Item Messages -->
                                <li class="cursor-pointer">
                                    <a
                                            class="group relative flex items-center gap-2.5 rounded-sm px-4 py-2 font-medium text-bodydark1 duration-300 ease-in-out hover:bg-graydark dark:hover:bg-meta-4"
                                            href="{{ path('client_overview', { clientId: client.id }) }}"
                                    >
                                        <svg class="size-6" fill="none" stroke="currentColor"
                                             stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H15"
                                                  stroke-linecap="round"
                                                  stroke-linejoin="round"/>
                                        </svg>
                                        Povratak
                                    </a>
                                </li>
                                <!-- Menu Item Messages -->
                            </ul>
                        </div>
                    </div>
                </nav>
                <!-- Sidebar Menu -->
            </div>
        </aside>

        <!-- ===== Sidebar End ===== -->

        <!-- ===== Content Area Start ===== -->
        <div
                class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden"
        >
            <!-- ===== Header Start ===== -->
            {% block header %}
                {{ parent() }}
            {% endblock %}
            <!-- ===== Header End ===== -->

            <!-- ===== Main Content Start ===== -->
            <main>
                <div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
                    <!-- Breadcrumb Start -->
                    <div
                            class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
                    >
                        <h2 class="text-title-md2 font-bold text-black dark:text-white">
                            Dopuni podatke
                        </h2>

                        <nav>
                            <ol class="flex items-center gap-2">
                                <li>
                                    <a class="font-medium" href="{{ path('admin_overview') }}">Dashboard /</a>
                                </li>
                                <li class="font-medium text-primary">Dopuni podatke</li>
                            </ol>
                        </nav>
                    </div>
                    <!-- Breadcrumb End -->
                    <div class="flex flex-col gap-5 md:gap-7 2xl:gap-10">
                        <!-- ====== Data Table Start -->
                        <div
                                class="rounded-sm border border-stroke bg-white shadow-default dark:border-strokedark dark:bg-boxdark"
                        >
                            <div
                                    class="data-table-common data-table-two max-w-full p-3"
                            >
                                <h3 class="title-dt font-bold text-black dark:text-white">
                                    Proverite koliko podataka nedostaje i dopunite
                                </h3>
                                <div>
                                    <form id="dataMissingForm" class="mt-5" method="GET">
                                        <div class="flex flex-wrap items-end gap-4">
                                            <!-- Device Select -->
                                            <div class="flex-1 min-w-[250px]">
                                                <label class="mb-2 block text-sm font-medium text-black dark:text-white">
                                                    Uređaj
                                                </label>
                                                <select class="hidden" x-cloak id="deviceSelect">
                                                    {% for option in deviceTypesDropdown %}
                                                        <option value="{{ option.value }}">{{ option.text }}</option>
                                                    {% endfor %}
                                                </select>

                                                <div x-data="dropdownDevice('deviceSelect', 'device')" x-init="loadOptions()" class="flex flex-col">
                                                    <input name="device" id="device" type="hidden" :value="selectedValue">
                                                    <div class="relative w-full">
                                                        <div @click="toggle()" class="w-full cursor-pointer">
                                                            <div class="flex rounded border-[1.5px] border-stroke bg-transparent px-4 py-2 font-normal outline-none transition focus:border-primary active:border-primary dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary">
                                                                <input placeholder="Izaberite uređaj"
                                                                       class="bg-transparent outline-none w-full cursor-pointer"
                                                                       readonly
                                                                       :value="selectedText">
                                                                <span class="ml-2 flex items-center">▼</span>
                                                            </div>
                                                        </div>

                                                        <div x-show="isOpen()"
                                                             class="absolute shadow top-full bg-white dark:bg-boxdark z-50 w-full left-0 rounded border overflow-y-auto mt-1"
                                                             style="max-height: 400px"
                                                             @click.outside="close">
                                                            <input type="text"
                                                                   x-model="search"
                                                                   placeholder="Pretraži uređaje..."
                                                                   @click.stop
                                                                   class="w-full p-2 border-b outline-none dark:bg-boxdark">
                                                            <div>
                                                                <template x-for="(option,index) in filteredOptions" :key="index">
                                                                    <div class="cursor-pointer px-4 py-2 hover:bg-gray-100 dark:hover:bg-meta-4"
                                                                         @click="select(index)"
                                                                         x-text="option.text">
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Date From -->
                                            <div class="w-[180px]">
                                                <label class="mb-2 block text-sm font-medium text-black dark:text-white">
                                                    Datum od
                                                </label>
                                                <div class="relative">
                                                    <input
                                                            class="form-datepicker w-full rounded border-[1.5px] border-stroke bg-transparent px-4 py-2 font-normal outline-none transition focus:border-primary active:border-primary dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary"
                                                            data-class="flatpickr-right"
                                                            id="datesDataFrom"
                                                            name="date_from"
                                                            onkeydown="return false"
                                                            placeholder="dd.mm.yyyy"
                                                    />
                                                    <div class="pointer-events-none absolute inset-0 left-auto right-4 flex items-center">
                                                        <svg fill="none" height="18" viewBox="0 0 18 18" width="18" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M15.7504 2.9812H14.2879V2.36245C14.2879 2.02495 14.0066 1.71558 13.641 1.71558C13.2754 1.71558 12.9941 1.99683 12.9941 2.36245V2.9812H4.97852V2.36245C4.97852 2.02495 4.69727 1.71558 4.33164 1.71558C3.96602 1.71558 3.68477 1.99683 3.68477 2.36245V2.9812H2.25039C1.29414 2.9812 0.478516 3.7687 0.478516 4.75308V14.5406C0.478516 15.4968 1.26602 16.3125 2.25039 16.3125H15.7504C16.7066 16.3125 17.5223 15.525 17.5223 14.5406V4.72495C17.5223 3.7687 16.7066 2.9812 15.7504 2.9812ZM1.77227 8.21245H4.16289V10.9968H1.77227V8.21245ZM5.42852 8.21245H8.38164V10.9968H5.42852V8.21245ZM8.38164 12.2625V15.0187H5.42852V12.2625H8.38164ZM9.64727 12.2625H12.6004V15.0187H9.64727V12.2625ZM9.64727 10.9968V8.21245H12.6004V10.9968H9.64727ZM13.8379 8.21245H16.2285V10.9968H13.8379V8.21245ZM2.25039 4.24683H3.71289V4.83745C3.71289 5.17495 3.99414 5.48433 4.35977 5.48433C4.72539 5.48433 5.00664 5.20308 5.00664 4.83745V4.24683H13.0504V4.83745C13.0504 5.17495 13.3316 5.48433 13.6973 5.48433C14.0629 5.48433 14.3441 5.20308 14.3441 4.83745V4.24683H15.7504C16.0316 4.24683 16.2566 4.47183 16.2566 4.75308V6.94683H1.77227V4.75308C1.77227 4.47183 1.96914 4.24683 2.25039 4.24683ZM1.77227 14.5125V12.2343H4.16289V14.9906H2.25039C1.96914 15.0187 1.77227 14.7937 1.77227 14.5125ZM15.7504 15.0187H13.8379V12.2625H16.2285V14.5406C16.2566 14.7937 16.0316 15.0187 15.7504 15.0187Z" fill="#64748B"/>
                                                        </svg>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Date To -->
                                            <div class="w-[180px]">
                                                <label class="mb-2 block text-sm font-medium text-black dark:text-white">
                                                    Datum do
                                                </label>
                                                <div class="relative">
                                                    <input
                                                            class="form-datepicker w-full rounded border-[1.5px] border-stroke bg-transparent px-4 py-2 font-normal outline-none transition focus:border-primary active:border-primary dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary"
                                                            data-class="flatpickr-right"
                                                            id="datesDataThru"
                                                            name="date_to"
                                                            onkeydown="return false"
                                                            placeholder="dd.mm.yyyy"
                                                    />
                                                    <div class="pointer-events-none absolute inset-0 left-auto right-4 flex items-center">
                                                        <svg fill="none" height="18" viewBox="0 0 18 18" width="18" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M15.7504 2.9812H14.2879V2.36245C14.2879 2.02495 14.0066 1.71558 13.641 1.71558C13.2754 1.71558 12.9941 1.99683 12.9941 2.36245V2.9812H4.97852V2.36245C4.97852 2.02495 4.69727 1.71558 4.33164 1.71558C3.96602 1.71558 3.68477 1.99683 3.68477 2.36245V2.9812H2.25039C1.29414 2.9812 0.478516 3.7687 0.478516 4.75308V14.5406C0.478516 15.4968 1.26602 16.3125 2.25039 16.3125H15.7504C16.7066 16.3125 17.5223 15.525 17.5223 14.5406V4.72495C17.5223 3.7687 16.7066 2.9812 15.7504 2.9812ZM1.77227 8.21245H4.16289V10.9968H1.77227V8.21245ZM5.42852 8.21245H8.38164V10.9968H5.42852V8.21245ZM8.38164 12.2625V15.0187H5.42852V12.2625H8.38164ZM9.64727 12.2625H12.6004V15.0187H9.64727V12.2625ZM9.64727 10.9968V8.21245H12.6004V10.9968H9.64727ZM13.8379 8.21245H16.2285V10.9968H13.8379V8.21245ZM2.25039 4.24683H3.71289V4.83745C3.71289 5.17495 3.99414 5.48433 4.35977 5.48433C4.72539 5.48433 5.00664 5.20308 5.00664 4.83745V4.24683H13.0504V4.83745C13.0504 5.17495 13.3316 5.48433 13.6973 5.48433C14.0629 5.48433 14.3441 5.20308 14.3441 4.83745V4.24683H15.7504C16.0316 4.24683 16.2566 4.47183 16.2566 4.75308V6.94683H1.77227V4.75308C1.77227 4.47183 1.96914 4.24683 2.25039 4.24683ZM1.77227 14.5125V12.2343H4.16289V14.9906H2.25039C1.96914 15.0187 1.77227 14.7937 1.77227 14.5125ZM15.7504 15.0187H13.8379V12.2625H16.2285V14.5406C16.2566 14.7937 16.0316 15.0187 15.7504 15.0187Z" fill="#64748B"/>
                                                        </svg>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Buttons -->
                                            <div class="flex gap-2">
                                                <button id="showDataMissing" type="button" class="rounded border border-primary bg-primary px-4 py-2 text-center font-medium text-white transition hover:bg-opacity-90">
                                                    Prikaži
                                                </button>
                                                <button id="insertData" type="button" class="rounded border border-meta-3 bg-meta-3 px-4 py-2 text-center font-medium transition hover:bg-opacity-90">
                                                    Popuni podatke
                                                </button>
                                            </div>
                                        </div>
                                    </form>

                                    <div class="mt-6">
                                        <h3 id="result" class="text-sm text-black dark:text-white">
                                            Stavite datume u prošlosti i izaberite uređaj za koji želite da vidite nedostajuće podatke.
                                        </h3>
                                    </div>

                                    <!-- Preview Table -->
                                    <div id="previewTableContainer" class="mt-6 hidden">
                                        <h4 class="mb-3 text-sm font-semibold text-black dark:text-white">Podaci koji će biti ubačeni:</h4>
                                        <div class="max-h-96 overflow-auto">
                                            <table class="w-full table-auto border-collapse">
                                                <thead class="sticky top-0 bg-gray-2 dark:bg-meta-4">
                                                    <tr>
                                                        <th class="border border-stroke px-3 py-2 text-left text-sm font-medium text-black dark:border-strokedark dark:text-white">Novi datum</th>
                                                        <th class="border border-stroke px-3 py-2 text-left text-sm font-medium text-black dark:border-strokedark dark:text-white">Originalni datum</th>
                                                        <th class="border border-stroke px-3 py-2 text-left text-sm font-medium text-black dark:border-strokedark dark:text-white">T1 (°C)</th>
                                                        <th class="border border-stroke px-3 py-2 text-left text-sm font-medium text-black dark:border-strokedark dark:text-white">RH1 (%)</th>
                                                        <th class="border border-stroke px-3 py-2 text-left text-sm font-medium text-black dark:border-strokedark dark:text-white">T2 (°C)</th>
                                                        <th class="border border-stroke px-3 py-2 text-left text-sm font-medium text-black dark:border-strokedark dark:text-white">RH2 (%)</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="previewTableBody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <!-- ===== Main Content End ===== -->
        </div>
    <!--dropdown logic-->
    <script>
        function dropdownDevice(deviceSelectId, preselectInputId = 'device') {
            return {
                options: [],
                show: false,
                search: '',
                selectedValue: '',
                selectedText: '',

                toggle() {
                    this.show = !this.show;
                },

                close() {
                    this.show = false;
                },

                isOpen() {
                    return this.show === true;
                },

                get filteredOptions() {
                    if (!this.search) return this.options;
                    return this.options.filter(opt =>
                        opt.text.toLowerCase().includes(this.search.toLowerCase())
                    );
                },

                select(index) {
                    const opt = this.filteredOptions[index];
                    this.selectedValue = opt.value;
                    this.selectedText = opt.text;
                    this.search = '';
                    this.close();
                },

                loadOptions() {
                    const select = document.getElementById(deviceSelectId);
                    const options = select.options;

                    this.options = [];

                    for (let i = 0; i < options.length; i++) {
                        this.options.push({
                            value: options[i].value,
                            text: options[i].innerText
                        });
                    }

                    setTimeout(() => {
                        const preselectInput = document.getElementById(preselectInputId);
                        if (preselectInput && preselectInput.value) {
                            const found = this.options.find(opt => opt.value === preselectInput.value);
                            if (found) {
                                this.selectedValue = found.value;
                                this.selectedText = found.text;
                            }
                        }
                    }, 1000);
                }
            };
        }
    </script>
        <!-- ===== Content Area End ===== -->
    </div>
    </body>
{% endblock %}